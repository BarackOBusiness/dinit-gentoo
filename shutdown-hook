#!/bin/sh
#
# run after all services have shut down and
# remaining processes have been terminated
#

export PATH=/sbin:/bin:/usr/sbin:/usr/bin

# assume proper directory
cd /usr/lib/dinit.d

if [ ! -e /run/dinit/container ]; then
    echo "Disabling swap..."
    swapoff -a
    echo "Unmounting filesystems..."
    /usr/lib/dinit.d/early/scripts/fs-fstab.sh stop
    echo "Remounting root read-only..."
    mount -n -o remount,ro /
fi

sync

if [ ! -e /run/dinit/container ]; then
    export DM_DISABLE_UDEV=1
    echo "Deactivating cryptdisks..."
    /usr/lib/dinit.d/early/scripts/cryptdisks.sh remaining stop
    echo "Deactivating volume groups..."
    /usr/lib/dinit.d/early/scripts/lvm.sh stop
    echo "Deactivating remaining cryptdisks..."
    /usr/lib/dinit.d/early/scripts/cryptdisks.sh early stop
fi
